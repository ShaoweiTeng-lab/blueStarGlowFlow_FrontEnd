<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-g2xAIV8pLElpOOzShLbg73DJYd2w21vCc6iW3E99eBtXRZK1nKYhM0nhP5oQhcP9" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>
<body>

    <title>Document</title>
</head>
<body>
    
    <div class="container">
        <div class="pt-5 text-center">
            <img class="d-block mx-auto mb-4" src="https://www.newebpay.com/ud/img/logo_sm2.png" alt="">
            <h2>藍新金流串接範例</h2> 
        </div>
        <div class="row my">
            <hr class="my-4">
            <div class="col-md">
                <h2 class="mt-3 mb-3">送出 MPG 交易</h2>
                <small style="color: red">MPG (Multiple Payment Gateway) 是藍新金流提供的 RWD 頁面 <br> 使用於線上交易的幕前情境供消費者進行付款</small>
                <form id = "createOrder" action="localhost:8080/createOrder" method="post">
                    <div class="mb-3">
                        <label class="form-label">訂單金額 </label>
                        <input type="text" class="form-control" name="Amt" placeholder="訂單金額">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">商品名稱 </label>
                        <input type="text" class="form-control" name="ItemDesc" placeholder="商品名稱">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">付款人電子信箱</label>
                        <input type="text" class="form-control" name="Email" placeholder="付款人電子信箱" value="sdonline13@gmail.com" required>
                    </div>
                    <input type="submit" class="btn btn-primary" value="送出">
                </form>
            </div>
            
        </div>
    </div>
    


    <form id="order-form" method="post" action=https://ccore.newebpay.com/MPG/mpg_gateway >
        <input type="hidden" name="MerchantID" value="MS151433308">
        <input type="hidden" name="TradeInfo" value="5AD598EADBA9908D6D6AE41859E45DA6511020E667BA7DA6E2BDA7D2E8762D803E69EB093D8952EDAC40763C1AD549A91E6C5077ABA3C86B5D07347A19DD1C15665B4E5F3DD84A860E12ADF01C952E654A1B76636B32AD1C69E0246999EC08DA6093E8BEF3D67C8641A03C3432817C27DF9A710414FE26D1EF09F92BF1965D8A26CEF680B05C52EF1AB6A3134462B50923BB24052CED0D1C526089E41F46DAB6424B7A659EB9E56D00E5DAB281CE4E540C82B0C3F9A335F2FD16DCD87C05BD79831C3840398F8906978644866222DE99DBFB9BCE4617608ACCBB0C2188F7792C">
        <input type="hidden" name="TradeSha" value="491C6371844A877C381E4FDBFF815E79FE22E526ABC7414E5569AF45496312A1">
        <input type="hidden" name="Version" value="2.0">
    </form>

    <script>
         $(document).ready(function(){ 
            $("#createOrder").submit(function(event){
                event.preventDefault(); // 阻止表單的預設提交行為 
                var form = document.getElementById("createOrder"); 
                let formData = new FormData(this); 
                fetch('http://localhost:8080/createOrder',{
                    body:formData,
                    method:"post"
                })
                .then(response => {
                    if (!response.ok) {
                    throw new Error('Network response was not ok');
                    }
                    return response.json(); // 將 Response 轉換為 JSON
                })
                .then(data => {
                    createOrderForm(data);
                    //console.log(data); // 處理成功的回應
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
             });
            });
            /**
             * 
             * 生成 藍星付款頁
            */
            function createOrderForm(jsonData){
                const form = document.createElement('form');
                form.setAttribute('MerchantID', jsonData.merchantID);
                form.setAttribute('TradeInfo', jsonData.tradeInfo);
                form.setAttribute('TradeSha', jsonData.tradeSha);
                form.setAttribute('Version', jsonData.version);
                form.setAttribute('method', 'post'); // 使用 POST 方法提交
                form.setAttribute('action', 'https://ccore.newebpay.com/MPG/mpg_gateway'); // 设置跳转的目标页面
                // 将表单添加到页面中
                document.body.appendChild(form);

                // 自动提交表单
                form.submit();
                console.log(jsonData);
            }
         
    </script>
    <!--  <script type="text/javascript">document.getElementById('order-form').submit();</script> -->
</body>
</html>

